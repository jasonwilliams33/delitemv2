<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope,delitemModalPubSub) {

	var c = this;

	//var code = generateQR(c.data.sys_id);



	//setTimeout(
	//function(){		
	//$scope.$parent.$parent.buttonClicked({ label: "OK", primary: true });  
	//var code = generateQR(c.data.sys_id);
	//},
	//3000
	//);

var code = generateQR(c.data.sys_id);


	//delitemModalPubSub.publish(c.data.sys_id);

	function generateQR(sys_id) {
		
			qrcode = new QRCode(document.getElementById('qrcode'), {
				text: sys_id,
				width: 128,
				height: 128,
				colorDark : "#000000",
				colorLight : "#ffffff",
				correctLevel : QRCode.CorrectLevel.H

			});

			img = qrcode._el.children[1];
			//imgs.push(img);

			var canvas = document.createElement("canvas");
			canvas.width = img.width;
			canvas.height = img.height;

			// Copy the image contents to the canvas
			var ctx = canvas.getContext("2d");
			ctx.drawImage(img, 0, 0);

			dataURL = canvas.toDataURL("image/png");

			console.log(dataURL);

			

		c.server.get({

			action: "updateDeliveryItem",
			delivery: sys_id,
			download: dataURL

		}).then(function(rsp) {

		})

	}

// 	function generateDataUrl (sys_id,callback) {
// 		alert(sys_id);

// 		qrcode = new QRCode(document.getElementById('qrcode'), {
			
// 			text: sys_id,
// 			width: 128,
// 			height: 128,
// 			colorDark : "#000000",
// 			colorLight : "#ffffff",
// 			correctLevel : QRCode.CorrectLevel.H

// 		});

// 		img = qrcode._el.children[1];
// 		//imgs.push(img);

// 		var canvas = document.createElement("canvas");
// 		canvas.width = img.width;
// 		canvas.height = img.height;

// 		// Copy the image contents to the canvas
// 		var ctx = canvas.getContext("2d");
// 		ctx.drawImage(img, 0, 0);

// 				//console.log(dataURL);
// 		response = canvas;

// 		setTimeout(function() {
// 		callback(null,response);	
// 		},5000);
		

// 	}

}]]></client_script>
        <controller_as>c</controller_as>
        <css>.qrcode{
	//display: none;
}

.containerQRCode,.containerLoader, .message{
	text-align: center;
}

.lds-ellipsis {
  display: inline-block;
  position: relative;
  width: 80px;
  height: 80px;
  
}
.lds-ellipsis div {
  position: absolute;
  top: 33px;
  width: 13px;
  height: 13px;
  border-radius: 50%;
  background: $brand-primary;
  animation-timing-function: cubic-bezier(0, 1, 1, 0);
}
.lds-ellipsis div:nth-child(1) {
  left: 8px;
  animation: lds-ellipsis1 0.6s infinite;
}
.lds-ellipsis div:nth-child(2) {
  left: 8px;
  animation: lds-ellipsis2 0.6s infinite;
}
.lds-ellipsis div:nth-child(3) {
  left: 32px;
  animation: lds-ellipsis2 0.6s infinite;
}
.lds-ellipsis div:nth-child(4) {
  left: 56px;
  animation: lds-ellipsis3 0.6s infinite;
}
@keyframes lds-ellipsis1 {
  0% {
    transform: scale(0);
  }
  100% {
    transform: scale(1);
  }
}
@keyframes lds-ellipsis3 {
  0% {
    transform: scale(1);
  }
  100% {
    transform: scale(0);
  }
}
@keyframes lds-ellipsis2 {
  0% {
    transform: translate(0, 0);
  }
  100% {
    transform: translate(24px, 0);
  }
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>delitem_generate_qr_code</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Delitem Generate QR Code</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {

	data.sys_id = input.sys_id;

	if(input && input.action == "updateDeliveryItem") {
		
		gs.error("JW Debug, Del Sys ID: " + JSON.stringify(input));

		var attach = new GlideRecordSecure(DelItemConstants.DELIVERY_TABLE);
		attach.get(input.delivery);

		var dataUrl = input.download;
		var dataUrlSplit = dataUrl.split('base64,');

		var attachment = new GlideSysAttachment();
		var attachmentSysId = attachment.writeBase64(attach, "qrcode.png", "image/png", dataUrlSplit[1]);

		attach.delivery_qr_code = attachmentSysId;
		attach.update();

	}

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-02-08 20:09:15</sys_created_on>
        <sys_id>ae71738f2f70ad10758993acf699b69d</sys_id>
        <sys_mod_count>45</sys_mod_count>
        <sys_name>Delitem Generate QR Code</sys_name>
        <sys_package display_value="Delitem" source="x_187394_delitem">ac22a5c32f771110758993acf699b6da</sys_package>
        <sys_policy/>
        <sys_scope display_value="Delitem">ac22a5c32f771110758993acf699b6da</sys_scope>
        <sys_update_name>sp_widget_ae71738f2f70ad10758993acf699b69d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-02-20 21:00:47</sys_updated_on>
        <template><![CDATA[<div class="containerLoader">
  <div>
    <span class="message">
      <h2>
        Generating QR Code
      </h2>
    </span>
  </div>
  <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
</div>
<div class="containerQRCode">
  <div class="qrcode" id="qrcode">
    <canvas id="canvas" width="200" height="200"></canvas>
  </div>
</div>
]]></template>
    </sp_widget>
</record_update>
